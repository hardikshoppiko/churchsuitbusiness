{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/apcrat/Documents/react/church_suit_business/affiliates/src/app/register/payment/%5Baffiliate_id%5D/payment-client.js"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport { loadStripe } from \"@stripe/stripe-js\";\nimport { Elements, PaymentElement, useElements, useStripe } from \"@stripe/react-stripe-js\";\n\nconst stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY);\n\nfunction CheckoutForm({ affiliateId }) {\n  const stripe = useStripe();\n  const elements = useElements();\n  const [loading, setLoading] = useState(false);\n  const [err, setErr] = useState(null);\n\n  async function onPay(e) {\n    e.preventDefault();\n    setErr(null);\n\n    if (!stripe || !elements) return;\n\n    setLoading(true);\n\n    const { error } = await stripe.confirmPayment({\n      elements,\n      confirmParams: {\n        return_url: `${window.location.origin}/register/payment/${affiliateId}/success`,\n      },\n    });\n\n    if (error) {\n      setErr(error.message || \"Payment failed.\");\n      setLoading(false);\n      return;\n    }\n  }\n\n  return (\n    <form onSubmit={onPay} className=\"card p-4\">\n      {err && <div className=\"alert alert-danger\">{err}</div>}\n\n      {/* IMPORTANT: Put layout options HERE */}\n      <PaymentElement\n        options={{\n          layout: {\n            type: \"tabs\", \n            defaultCollapsed: false,\n          },\n        }}\n      />\n\n      <button\n        className=\"btn btn-primary btn-lg mt-4 w-100\"\n        disabled={!stripe || loading}\n        type=\"submit\"\n      >\n        {loading ? \"Processing...\" : \"Pay now & Activate Subscription\"}\n      </button>\n    </form>\n  );\n}\n\nexport default function PaymentClient({ affiliateId }) {\n  const [clientSecret, setClientSecret] = useState(null);\n  const [paid, setPaid] = useState(false);\n  const [err, setErr] = useState(null);\n\n  // Validate affiliateId early\n  if (!affiliateId || Number.isNaN(Number(affiliateId))) {\n    return <div className=\"alert alert-danger\">Invalid affiliate id in URL.</div>;\n  }\n\n  useEffect(() => {\n    let mounted = true;\n\n    async function init() {\n      setErr(null);\n\n      const res = await fetch(`/api/affiliate/payment-intent`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ affiliate_id: affiliateId }),\n        cache: \"no-store\",\n      });\n\n      const data = await res.json().catch(() => ({}));\n\n      // console.log(\"Payment intent init:\", { res, data });\n\n      if (!mounted) return;\n\n      if (!res.ok) {\n        setErr(data?.message || \"Could not initialize payment.\");\n        return;\n      }\n\n      if (data.affiliate_status === \"paid\") {\n        setPaid(true);\n        return;\n      }\n\n      setClientSecret(data.clientSecret);\n    }\n\n    init();\n\n    return () => {\n      mounted = false;\n    };\n  }, [affiliateId]);\n\n  // Keep Elements options ONLY for clientSecret + appearance\n  const options = useMemo(() => {\n    if (!clientSecret) return null;\n\n    return {\n      clientSecret,\n      appearance: { theme: \"stripe\" },\n    };\n  }, [clientSecret]);\n\n  if (paid) {\n    return <div className=\"alert alert-success\">Payment already completed.</div>;\n  }\n\n  if (err) {\n    return <div className=\"alert alert-danger\">{err}</div>;\n  }\n\n  if (!clientSecret || !options) {\n    return <div className=\"text-muted\">Loading payment form...</div>;\n  }\n\n  return (\n    <Elements stripe={stripePromise} options={options}>\n      <CheckoutForm affiliateId={affiliateId} />\n    </Elements>\n  );\n}"],"names":[],"mappings":"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"}}]
}