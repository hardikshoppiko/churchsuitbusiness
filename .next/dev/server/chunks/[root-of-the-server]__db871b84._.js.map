{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///Users/apcrat/Documents/react/church_suit_business/affiliates/src/lib/db.js"],"sourcesContent":["import mysql from \"mysql2/promise\";\n\nexport const db = mysql.createPool({\n  host: process.env.DB_HOST,\n  user: process.env.DB_USER,\n  password: process.env.DB_PASSWORD,\n  database: process.env.DB_NAME,\n  port: Number(process.env.DB_PORT || 3306),\n  waitForConnections: true,\n  connectionLimit: 10,\n});"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,KAAK,8IAAK,CAAC,UAAU,CAAC;IACjC,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,UAAU,QAAQ,GAAG,CAAC,WAAW;IACjC,UAAU,QAAQ,GAAG,CAAC,OAAO;IAC7B,MAAM,OAAO,QAAQ,GAAG,CAAC,OAAO,IAAI;IACpC,oBAAoB;IACpB,iBAAiB;AACnB"}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///Users/apcrat/Documents/react/church_suit_business/affiliates/src/lib/db-utils.js"],"sourcesContent":["import { clsx } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\nimport crypto from \"crypto\";\nimport { serialize as phpSerialize } from \"php-serialize\";\n\n/**\n * shadcn utility: merges tailwind classes safely\n */\nexport function cn(...inputs) {\n  return twMerge(clsx(inputs));\n}\n\nexport function sha1(str) {\n  return crypto.createHash(\"sha1\").update(String(str)).digest(\"hex\");\n}\n\n// OpenCart-compatible 9-char salt\nexport function generateSalt() {\n  return crypto\n    .createHash(\"md5\")\n    .update(crypto.randomBytes(16).toString(\"hex\") + Date.now())\n    .digest(\"hex\")\n    .substring(0, 9);\n}\n\n// OpenCart hash: sha1(salt . sha1(salt . sha1(password)))\nexport function ocHashPassword(password, salt) {\n  return sha1(salt + sha1(salt + sha1(password)));\n}\n\nexport function ocVerifyPassword(inputPassword, storedSalt, storedHash) {\n  return ocHashPassword(inputPassword, storedSalt) === storedHash;\n}\n\n// OpenCart-style db escape (like $this->db->escape)\nexport function dbEscape(value) {\n  if (value === null || value === undefined) return \"\";\n  return String(value)\n    .replace(/\\\\/g, \"\\\\\\\\\")\n    .replace(/\\u0008/g, \"\\\\b\")\n    .replace(/\\t/g, \"\\\\t\")\n    .replace(/\\0/g, \"\\\\0\")\n    .replace(/\\n/g, \"\\\\n\")\n    .replace(/\\r/g, \"\\\\r\")\n    .replace(/\\u001a/g, \"\\\\Z\")\n    .replace(/\\x1a/g, \"\\\\Z\")\n    .replace(/'/g, \"\\\\'\")\n    .replace(/\"/g, '\\\\\"');\n}\n\n// Save only domain (remove https:// and www)\nexport function stripWebsite(url = \"\") {\n  return String(url)\n    .trim()\n    .replace(/^https?:\\/\\//i, \"\")\n    .replace(/^www\\./i, \"\")\n    .replace(/\\/+$/, \"\");\n}\n\nexport function isEmail(v) {\n  return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]{2,}$/.test(String(v || \"\").trim());\n}\n\nexport function isTenDigitPhone(v) {\n  return /^\\d{10}$/.test(String(v || \"\").trim());\n}\n\nexport function normalizeLogin(v) {\n  return String(v || \"\").trim();\n}\n\nexport function ocSerialize(value) {\n  return phpSerialize(value);\n}\n\nexport function isTruthy(v) {\n  return v === true || v === 1 || v === \"1\" || String(v).toLowerCase() === \"true\";\n}\n\nexport function getClientIp(req) {\n  if (!req?.headers) return \"127.0.0.1\";\n\n  // Proxy / Load balancer / Vercel\n  const xForwardedFor = req.headers.get(\"x-forwarded-for\");\n  if (xForwardedFor) {\n    // Can be: \"client, proxy1, proxy2\"\n    return xForwardedFor.split(\",\")[0].trim();\n  }\n\n  // Cloudflare\n  const cfIp = req.headers.get(\"cf-connecting-ip\");\n  if (cfIp) return cfIp;\n\n  // Fallback (local dev)\n  return \"127.0.0.1\";\n}\n\nexport function getFrontClientIp() {\n  const h = headers();\n\n  // Common proxy headers\n  const xff = h.get(\"x-forwarded-for\");\n  if (xff) return xff.split(\",\")[0].trim();\n\n  const realIp = h.get(\"x-real-ip\");\n  if (realIp) return realIp.trim();\n\n  // Fallback\n  return \"0.0.0.0\";\n}\n\nexport function money(v) {\n  const n = Number(v || 0);\n  return Number.isFinite(n) ? `$${n.toFixed(2)}` : \"$0.00\";\n}\n\nfunction parseDate(input) {\n  if (!input) return null;\n\n  // Already Date object\n  if (input instanceof Date) {\n    return isNaN(input.getTime()) ? null : input;\n  }\n\n  if (typeof input !== \"string\") return null;\n\n  // ISO or yyyy-mm-dd hh:mm:ss (MySQL)\n  if (/^\\d{4}-\\d{2}-\\d{2}/.test(input)) {\n    const d = new Date(input.replace(\" \", \"T\"));\n    return isNaN(d.getTime()) ? null : d;\n  }\n\n  // dd/mm/yyyy or dd/mm/yyyy hh:mm:ss\n  if (/^\\d{2}\\/\\d{2}\\/\\d{4}/.test(input)) {\n    const [datePart, timePart] = input.split(\" \");\n    const [dd, mm, yyyy] = datePart.split(\"/\");\n\n    const iso = `${yyyy}-${mm}-${dd}${timePart ? \"T\" + timePart : \"\"}`;\n    const d = new Date(iso);\n    return isNaN(d.getTime()) ? null : d;\n  }\n\n  // Fallback: let JS try\n  const d = new Date(input);\n  return isNaN(d.getTime()) ? null : d;\n}\n\n/**\n * Format date as MM/DD/YYYY (default)\n */\nexport function formatDate(input, format = \"MM/DD/YYYY\") {\n  const d = parseDate(input);\n\n  if (!d) return \"\";\n\n  const map = {\n    DD: String(d.getDate()).padStart(2, \"0\"),\n    MM: String(d.getMonth() + 1).padStart(2, \"0\"),\n    YYYY: d.getFullYear(),\n    HH: String(d.getHours()).padStart(2, \"0\"),\n    mm: String(d.getMinutes()).padStart(2, \"0\"),\n    ss: String(d.getSeconds()).padStart(2, \"0\"),\n  };\n\n  return format.replace(/DD|MM|YYYY|HH|mm|ss/g, (k) => map[k]);\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 298, "column": 0}, "map": {"version":3,"sources":["file:///Users/apcrat/Documents/react/church_suit_business/affiliates/src/lib/stripe.js"],"sourcesContent":["import Stripe from \"stripe\";\n\nexport const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\n  apiVersion: \"2024-06-20\",\n});"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,SAAS,IAAI,mKAAM,CAAC,QAAQ,GAAG,CAAC,iBAAiB,EAAE;IAC9D,YAAY;AACd"}},
    {"offset": {"line": 311, "column": 0}, "map": {"version":3,"sources":["file:///Users/apcrat/Documents/react/church_suit_business/affiliates/src/lib/affiliate-payment-service.js"],"sourcesContent":["import { db } from \"@/lib/db\";\nimport { stripe } from \"@/lib/stripe\";\nimport { dbEscape } from \"@/lib/db-utils\";\n\nasync function getAffiliateById(affiliate_id) {\n  const [rows] = await db.query(`SELECT * FROM affiliate WHERE affiliate_id='${dbEscape(Number(affiliate_id))}' LIMIT 1`);\n  return rows?.[0] || null;\n}\n\nasync function updateAffiliate(affiliate_id, patch) {\n  const sets = Object.keys(patch)\n    .map((k) => `\\`${k}\\`='${dbEscape(patch[k])}'`)\n    .join(\", \");\n\n  await db.query(`UPDATE affiliate SET ${sets}, date_modified=NOW() WHERE affiliate_id='${dbEscape(Number(affiliate_id))}'`);\n}\n\n/**\n * Returns:\n *  - { affiliate_status:\"paid\" } if already paid/active\n *  - { affiliate_status:\"ready\", clientSecret } to show Stripe Payment Element\n */\nexport async function getSubscriptionClientSecret(affiliate_id) {\n  const affiliate = await getAffiliateById(affiliate_id);\n\n  if (!affiliate) {\n    return { affiliate_status: \"not_found\" };\n  }\n\n  // If your DB marks already paid\n  if (affiliate.payment_status !== undefined && String(affiliate.payment_status || \"\").toLowerCase() === \"paid\") {\n    return { affiliate_status: \"paid\" };\n  }\n\n  // 1) Stripe customer\n  let stripe_customer_id = affiliate.stripe_customer_id || \"\";\n\n  if (!stripe_customer_id) {\n    const customer = await stripe.customers.create({\n      email: affiliate.email,\n      name: `${affiliate.firstname} ${affiliate.lastname}`,\n      phone: affiliate.telephone,\n      metadata: { affiliate_id: String(affiliate.affiliate_id) },\n    });\n\n    stripe_customer_id = customer.id;\n\n    await updateAffiliate(affiliate.affiliate_id, {\n      stripe_customer_id,\n    });\n  }\n\n  // 2) Try reuse stored subscription if exists\n  if (affiliate.recurring_billing_id) {\n    try {\n      const sub = await stripe.subscriptions.retrieve(\n        affiliate.recurring_billing_id,\n        { expand: [\"latest_invoice.payment_intent\"] }\n      );\n\n      // If already active -> mark paid\n      if (sub.status === \"active\" || sub.status === \"trialing\") {\n        await updateAffiliate(affiliate.affiliate_id, { payment_status: \"paid\" });\n        return { affiliate_status: \"paid\" };\n      }\n\n      const pi = sub.latest_invoice?.payment_intent;\n      if (pi?.client_secret) {\n        return { affiliate_status: \"ready\", clientSecret: pi.client_secret };\n      }\n    } catch (e) {\n      // ignore and create new subscription\n    }\n  }\n\n  // 3) Create new incomplete subscription\n  const priceId = affiliate.stripe_plan_id; // must be Stripe PRICE ID\n\n  if (!priceId) {\n    return { affiliate_status: \"error\", message: \"Stripe plan/price id missing.\" };\n  }\n\n  const subscription = await stripe.subscriptions.create({\n    customer: stripe_customer_id,\n    items: [{ price: priceId }],\n    payment_behavior: \"default_incomplete\",\n    payment_settings: { \n      payment_method_types: [\"card\"],\n      save_default_payment_method: \"on_subscription\"\n    },\n    expand: [\"latest_invoice.payment_intent\"],\n    metadata: {\n      affiliate_id: String(affiliate.affiliate_id),\n      affiliate_plan_id: String(affiliate.affiliate_plan_id || \"\"),\n    },\n  });\n\n  const pi = subscription.latest_invoice?.payment_intent;\n\n  if (!pi?.client_secret) {\n    return { affiliate_status: \"error\", message: \"Could not create PaymentIntent.\" };\n  }\n\n  await updateAffiliate(affiliate.affiliate_id, {\n    stripe_customer_id: stripe_customer_id,\n    recurring_billing_id: subscription.id,\n    stripe_payment_intent_id: pi.id,\n    affiliate_status_id: 5, // Pending Payment\n  });\n\n  return { affiliate_status: \"ready\", clientSecret: pi.client_secret };\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 438, "column": 0}, "map": {"version":3,"sources":["file:///Users/apcrat/Documents/react/church_suit_business/affiliates/src/app/api/affiliate/payment-intent/route.js"],"sourcesContent":["import { db } from \"@/lib/db\";\nimport { dbEscape } from \"@/lib/db-utils\";\n\nimport { getSubscriptionClientSecret } from \"@/lib/affiliate-payment-service\";\n\nexport async function POST(req) {\n  const body = await req.json().catch(() => ({}));\n  const affiliate_id = body?.affiliate_id;\n\n  if (!affiliate_id) {\n    return Response.json({ message: \"affiliate_id is required\" }, { status: 400 });\n  }\n\n  const result = await getSubscriptionClientSecret(affiliate_id);\n\n  if (result.affiliate_status === \"not_found\") {\n    return Response.json({ message: \"Affiliate not found\" }, { status: 404 });\n  }\n\n  if (result.affiliate_status === \"paid\") {\n    return Response.json({ affiliate_status: \"paid\" });\n  }\n\n  if (result.affiliate_status === \"error\") {\n    return Response.json({ message: result.message || \"Payment init failed\" }, { status: 500 });\n  }\n\n  return Response.json({\n    affiliate_status: \"ready\",\n    clientSecret: result.clientSecret,\n  });\n}\n\n/**\n * âœ… GET (NEW)\n * Used by success page to show affiliate + last payment info\n *\n * Example:\n * /api/affiliate/payment-intent?affiliate_id=123\n */\nexport async function GET(req) {\n  try {\n    const url = new URL(req.url);\n    const affiliate_id = Number(url.searchParams.get(\"affiliate_id\") || 0);\n\n    if (!affiliate_id) {\n      return Response.json({ message: \"affiliate_id is required\" }, { status: 400 });\n    }\n\n    // Affiliate info\n    const [affRows] = await db.query(`SELECT * FROM affiliate WHERE affiliate_id=${affiliate_id}`);\n\n    const affiliate = affRows?.[0] || null;\n\n    if (!affiliate) {\n      return Response.json({ message: \"Affiliate not found\" }, { status: 404 });\n    }\n\n    // Latest payment row (for UI)\n    const [payRows] = await db.query(`SELECT affiliate_payment_id, payment_charge_id, invoice_number, amount, start_date, end_date, payment_status, date_added FROM affiliate_payment WHERE affiliate_id=${affiliate_id} ORDER BY affiliate_payment_id DESC LIMIT 1`);\n\n    const latest_payment = payRows?.[0] || null;\n\n    // Stage helper (first vs renewal)\n    const [firstPaidRows] = await db.query(`SELECT affiliate_payment_id FROM affiliate_payment WHERE affiliate_id=${affiliate_id} AND payment_status=1 ORDER BY affiliate_payment_id ASC LIMIT 1`);\n\n    const payment_stage = firstPaidRows?.length ? \"renewal\" : \"first\";\n\n    return Response.json({\n      success: true,\n      affiliate,\n      latest_payment,\n      payment_stage,\n    });\n  } catch (e) {\n    return Response.json({ message: e?.message || \"Server error\" }, { status: 500 });\n  }\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AAEA;;;;AAEO,eAAe,KAAK,GAAG;IAC5B,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;IAC7C,MAAM,eAAe,MAAM;IAE3B,IAAI,CAAC,cAAc;QACjB,OAAO,SAAS,IAAI,CAAC;YAAE,SAAS;QAA2B,GAAG;YAAE,QAAQ;QAAI;IAC9E;IAEA,MAAM,SAAS,MAAM,IAAA,8KAA2B,EAAC;IAEjD,IAAI,OAAO,gBAAgB,KAAK,aAAa;QAC3C,OAAO,SAAS,IAAI,CAAC;YAAE,SAAS;QAAsB,GAAG;YAAE,QAAQ;QAAI;IACzE;IAEA,IAAI,OAAO,gBAAgB,KAAK,QAAQ;QACtC,OAAO,SAAS,IAAI,CAAC;YAAE,kBAAkB;QAAO;IAClD;IAEA,IAAI,OAAO,gBAAgB,KAAK,SAAS;QACvC,OAAO,SAAS,IAAI,CAAC;YAAE,SAAS,OAAO,OAAO,IAAI;QAAsB,GAAG;YAAE,QAAQ;QAAI;IAC3F;IAEA,OAAO,SAAS,IAAI,CAAC;QACnB,kBAAkB;QAClB,cAAc,OAAO,YAAY;IACnC;AACF;AASO,eAAe,IAAI,GAAG;IAC3B,IAAI;QACF,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;QAC3B,MAAM,eAAe,OAAO,IAAI,YAAY,CAAC,GAAG,CAAC,mBAAmB;QAEpE,IAAI,CAAC,cAAc;YACjB,OAAO,SAAS,IAAI,CAAC;gBAAE,SAAS;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAC9E;QAEA,iBAAiB;QACjB,MAAM,CAAC,QAAQ,GAAG,MAAM,wHAAE,CAAC,KAAK,CAAC,CAAC,2CAA2C,EAAE,cAAc;QAE7F,MAAM,YAAY,SAAS,CAAC,EAAE,IAAI;QAElC,IAAI,CAAC,WAAW;YACd,OAAO,SAAS,IAAI,CAAC;gBAAE,SAAS;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,8BAA8B;QAC9B,MAAM,CAAC,QAAQ,GAAG,MAAM,wHAAE,CAAC,KAAK,CAAC,CAAC,mKAAmK,EAAE,aAAa,2CAA2C,CAAC;QAEhQ,MAAM,iBAAiB,SAAS,CAAC,EAAE,IAAI;QAEvC,kCAAkC;QAClC,MAAM,CAAC,cAAc,GAAG,MAAM,wHAAE,CAAC,KAAK,CAAC,CAAC,sEAAsE,EAAE,aAAa,+DAA+D,CAAC;QAE7L,MAAM,gBAAgB,eAAe,SAAS,YAAY;QAE1D,OAAO,SAAS,IAAI,CAAC;YACnB,SAAS;YACT;YACA;YACA;QACF;IACF,EAAE,OAAO,GAAG;QACV,OAAO,SAAS,IAAI,CAAC;YAAE,SAAS,GAAG,WAAW;QAAe,GAAG;YAAE,QAAQ;QAAI;IAChF;AACF"}}]
}