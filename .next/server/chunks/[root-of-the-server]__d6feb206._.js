module.exports=[93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},24361,(e,t,a)=>{t.exports=e.x("util",()=>require("util"))},54799,(e,t,a)=>{t.exports=e.x("crypto",()=>require("crypto"))},27699,(e,t,a)=>{t.exports=e.x("events",()=>require("events"))},88947,(e,t,a)=>{t.exports=e.x("stream",()=>require("stream"))},6461,(e,t,a)=>{t.exports=e.x("zlib",()=>require("zlib"))},92509,(e,t,a)=>{t.exports=e.x("url",()=>require("url"))},46164,e=>{"use strict";var t=e.i(47909),a=e.i(74017),r=e.i(96250),n=e.i(59756),i=e.i(61916),o=e.i(74677),l=e.i(69741),s=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),c=e.i(66012),f=e.i(70101),m=e.i(26937),h=e.i(10372),_=e.i(93695);e.i(52474);var g=e.i(220),R=e.i(79058);let E=process.env.APP_URL||"http://localhost:3000",x=+(!0===process.env.IS_DEVELOPMENT||"true"===process.env.IS_DEVELOPMENT);function v(e="",t={}){let a=String(e||"");for(let[e,r]of Object.entries(t))a=a.replaceAll(`{{${e}}}`,String(r??""));return a}async function w({to:e,subject:t,html:a}){return console.log("EMAIL SEND:",{to:e,subject:t}),{provider:"stub",provider_message_id:`email_${Date.now()}`}}async function y({to:e,text:t}){return console.log("SMS SEND:",{to:e,text:t}),null}function N(){return Date.now()}async function S(e=[]){if(!e.length)return new Map;let t=e.map(e=>Number(e)).filter(Boolean).join(",");if(!t)return new Map;let[a]=await R.db.query(`SELECT a.affiliate_id, MAX(a.date_added) AS last_activity FROM affiliate_activity a WHERE a.affiliate_id IN (${t}) GROUP BY a.affiliate_id`),r=new Map;for(let e of a||[])e?.affiliate_id&&r.set(Number(e.affiliate_id),e.last_activity);return r}async function b({affiliate_id:e,rule_id:t,channel:a}){let[r]=await R.db.query(`
    SELECT send_log_id
    FROM affiliate_automation_send_log
    WHERE affiliate_id='${Number(e)}'
      AND rule_id='${Number(t)}'
      AND channel='${String(a)}'
    LIMIT 1
  `);return!!r?.length}async function A({affiliate_id:e,rule_id:t,template_code:a,cohort:r,channel:n,dueAtMs:i,provider_message_id:o=""}){let l=`FROM_UNIXTIME(${Math.floor(i/1e3)})`;await R.db.query(`
    INSERT INTO affiliate_automation_send_log
      (affiliate_id, rule_id, template_code, cohort, channel,
       due_at, sent_at, provider_message_id, date_added)
    VALUES
      ('${Number(e)}',
       '${Number(t)}',
       '${String(a)}',
       '${String(r)}',
       '${String(n)}',
       ${l},
       NOW(),
       '${String(o||"")}',
       NOW())
  `)}async function C(e){let t=N(),[a]=await R.db.query("SELECT * FROM affiliate_automation_rule WHERE status=1 AND cohort='lead' ORDER BY delay_minutes ASC");if(!a?.length)return Response.json({ok:!0,message:"No rules found",took_ms:N()-t});let[r]=await R.db.query("SELECT affiliate_id, firstname, lastname, email, telephone, date_added, affiliate_status_id, stop_automation FROM affiliate WHERE affiliate_status_id=15 AND status=0 AND is_delete=0 AND stop_automation=0 ORDER BY affiliate_id DESC LIMIT 500");if(!r?.length)return Response.json({ok:!0,message:"No lead affiliates",took_ms:N()-t});let n=r.map(e=>Number(e.affiliate_id)).filter(Boolean),i=await S(n),o=Array.from(new Set(a.map(e=>String(e.template_code||"")).filter(Boolean))),l=new Map;if(o.length){let e=o.map(e=>`'${e.replaceAll("'","''")}'`).join(","),[t]=await R.db.query(`SELECT * FROM affiliate_automation_template WHERE status=1 AND code IN (${e})`);for(let e of t||[])l.set(`${e.code}:${e.channel}`,e)}let s=0,u=0,d=0,p=0,c=0,f=0,m=0,h=0,_=N();for(let e of r){let t=Number(e.affiliate_id);if(!t)continue;let r=i.get(t)||e.date_added,n=r?new Date(r).getTime():0;if(!n)continue;let o=`${E}/register/payment/${t}`,g={affiliate_id:t,firstname:e.firstname||"",lastname:e.lastname||"",email:e.email||"",telephone:e.telephone||"",payment_url:o,short_payment_url:o};for(let r of a){s++;let a=Number(r.rule_id),i=String(r.channel),o=String(r.template_code),R=String(r.cohort),E=n+60*Number(r.delay_minutes||0)*1e3;if(!x&&_<E){c++;continue}if(await b({affiliate_id:t,rule_id:a,channel:i})){p++;continue}let N=l.get(`${o}:${i}`);if(!N){f++;continue}if("email"===i&&!String(e.email||"").trim()||"sms"===i&&!String(e.telephone||"").trim()){m++;continue}let S=v(N.subject||"",g),C=v(N.body||"",g),T=null;try{"email"===i?T=await w({to:e.email,subject:S,html:C}):"sms"===i&&(T=await y({to:e.telephone,text:C}))}catch(e){console.log("Send exception:",e.message),T=null}T?(await A({affiliate_id:t,rule_id:a,template_code:o,cohort:R,channel:i,dueAtMs:E,provider_message_id:T?.provider_message_id||""}),"email"===i&&u++,"sms"===i&&d++):h++}}return Response.json({ok:!0,cohort:"lead",totals:{affiliates:r.length,rules:a.length,checked:s,sentEmail:u,sentSms:d,skippedAlreadySent:p,skippedNotDue:c,skippedNoTemplate:f,skippedNoContact:m,failedSend:h},took_ms:N()-t})}e.s(["GET",()=>C],61693);var T=e.i(61693);let O=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/automation/cron/route",pathname:"/api/automation/cron",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/automation/cron/route.js",nextConfigOutput:"",userland:T}),{workAsyncStorage:q,workUnitAsyncStorage:M,serverHooks:$}=O;function D(){return(0,r.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:M})}async function I(e,t,r){O.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/automation/cron/route";R=R.replace(/\/index$/,"")||"/";let E=await O.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:x,params:v,nextConfig:w,parsedUrl:y,isDraftMode:N,prerenderManifest:S,routerServerContext:b,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,resolvedPathname:T,clientReferenceManifest:q,serverActionsManifest:M}=E,$=(0,l.normalizeAppPath)(R),D=!!(S.dynamicRoutes[$]||S.routes[T]),I=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,y,!1):t.end("This page could not be found"),null);if(D&&!N){let e=!!S.routes[T],t=S.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await I();throw new _.NoFallbackError}}let P=null;!D||O.isDev||N||(P="/index"===(P=T)?"/":P);let k=!0===O.isDev||!D,j=D&&!k;M&&q&&(0,o.setManifestsSingleton)({page:R,clientReferenceManifest:q,serverActionsManifest:M});let H=e.method||"GET",U=(0,i.getTracer)(),L=U.getActiveScopeSpan(),F={params:v,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,n)=>O.onRequestError(e,t,r,n,b)},sharedContext:{buildId:x}},B=new s.NodeNextRequest(e),W=new s.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let o=async e=>O.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=U.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${H} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${R}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),s=async n=>{var i,s;let u=async({previousCacheEntry:a})=>{try{if(!l&&A&&C&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let s=F.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let u=F.renderOpts.collectedTags;if(!D)return await (0,c.sendResponse)(B,W,i,F.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:A})},!1,b),t}},d=await O.handleResponse({req:e,nextConfig:w,cacheKey:P,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:l});if(!D)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(s=d.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&D||_.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,c.sendResponse)(B,W,new Response(d.value.body,{headers:_,status:d.value.status||200})),null};L?await s(L):await U.withPropagatedContext(e.headers,()=>U.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${R}`,kind:i.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},s))}catch(t){if(t instanceof _.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:A})},!1,b),D)throw t;return await (0,c.sendResponse)(B,W,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>D,"routeModule",()=>O,"serverHooks",()=>$,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>M],46164)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__d6feb206._.js.map